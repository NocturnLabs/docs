# OpenCode Autocode

**OpenCode Autocode** is an advanced autonomous coding agent and scaffolding engine designed to accelerate software development within the OpenCode ecosystem. It bridges the gap between high-level project specifications and functional code by orchestrating AI models to plan, implement, verify, and refine features autonomously.

> [!NOTE]
> This tool is part of the **NocturnLabs Tools** suite and is designed to work seamlessly with the OpenCode CLI.

## Key Capabilities

*   **Interactive Scaffolding**: A TUI-driven wizard that turns vague ideas into detailed technical specifications (`app_spec.md`) and boilerplate code.
*   **Autonomous Vibe Loop**: A continuous iterator that picks up features, implements them, runs verifications, and fixes bugs without human intervention.
*   **Context-Aware Conductor**: Manages project context (`.conductor/` directory) to ensure the AI understands the broader architecture and tech stack.
*   **Security-First Design**: Built-in allowlists and blocked patterns to prevent destructive operations during autonomous runs.
*   **Multi-Model Orchestration**: Intelligently routes task types (reasoning vs. coding vs. fixing) to the most appropriate user-configured LLMs.

---

## Installation

### Method 1: Build from Source (Recommended)

Ensure you have Rust and Cargo installed (v1.75+).

```bash
git clone https://github.com/nocturnlabs/opencode-autocode.git
cd opencode-autocode
cargo install --path .
```

### Method 2: Binary Download

Pre-compiled binaries are available for Linux, macOS, and Windows on the [Releases](https://github.com/nocturnlabs/opencode-autocode/releases) page.

1.  Download the binary for your architecture.
2.  Rename it to `opencode-autocode`.
3.  Move it to a directory in your `PATH` (e.g., `/usr/local/bin`).
4.  Make it executable: `chmod +x /usr/local/bin/opencode-autocode`.

### Verification

Verify the installation by checking the version:

```bash
opencode-autocode --version
# Output: opencode-autocode 0.6.0
```

---

## Getting Started

OpenCode Autocode operates in two primary modes: **Interactive Scaffolding** (for new projects) and **Autonomous Execution** (for existing projects).

### 1. Quick Start: Interactive Mode

To start a new project from scratch, simply run the command without arguments to launch the TUI wizard:

```bash
opencode-autocode
```

**The Wizard Workflow:**
1.  **Project Name**: Enter a name for your new project.
2.  **Description**: Describe what you want to build (e.g., "A modern Kanban board with drag-and-drop").
3.  **Tech Stack Selection**: Choose your preferred languages and frameworks.
4.  **Spec Generation**: The AI analyzes your inputs and generates a detailed `app_spec.md`.
5.  **Review & Scaffolding**: You can edit the spec before the tool generates the initial project files.

### 2. Autonomous Mode: The Vibe Loop

Once your project is scaffolded (or if you are in an existing project), you can enable the autonomous agent to start implementing features.

```bash
# Run the autonomous loop for a maximum of 5 iterations
opencode-autocode vibe --limit 5
```

The agent will:
1.  Read the `status.md` or database to find the next pending feature.
2.  Analyze the `app_spec.md` and codebase.
3.  Generate an implementation plan.
4.  Write the code.
5.  Run verification commands (tests, builds).
6.  If verification fails, it attempts to fix the errors (up to the configured retry limit).

---

## Core Features Breakdown

### Project Conductor
The **Conductor** is the context management engine. It maintains a set of markdown files in `.conductor/` that serve as the "long-term memory" for the agent.
*   `product.md`: High-level product goals and user stories.
*   `tech_stack.md`: Detailed constraints on libraries and versions.
*   `architecture.md`: System design and data flow.
*   `tracks/`: Contains granular "track" files for specific implementation paths.

> [!IMPORTANT]
> Keep the Conductor files up to date. The quality of the autonomous output is directly proportional to the quality of the context provided here.

### Parallel Workers
Autocode can utilize Git worktrees to run multiple implementation agents in parallel.

```bash
# Run 3 parallel workers
opencode-autocode vibe --parallel 3
```

Each worker:
1.  Creates a temporary git worktree.
2.  Checks out a feature branch.
3.  Implements a distinct feature.
4.  Merges back to the main branch upon success.

### Self-Enhancement (`enhance`)
The `enhance` mode is distinct from `vibe`. While `vibe` focuses on "to-do" lists, `enhance` proactively scans the codebase for improvements, refactoring opportunities, and missing documentation.

```bash
opencode-autocode enhance --limit 2
```

---

## Specification Reference (`app_spec.md`)

The `app_spec.md` file is the source of truth for the project. It uses a custom XML-like structure that is optimized for LLM parsing.

### File Structure

```xml
<project_specification>
  <project_name>My App</project_name>

  <overview>
    Application overview text...
  </overview>

  <technology_stack>
    <languages>Rust, TypeScript</languages>
    <frameworks>Axum, React</frameworks>
    <tools>Docker</tools>
  </technology_stack>

  <core_features>
    <feature priority="critical">
      <name>User Authentication</name>
      <description>JWT-based auth flow...</description>
      <sub_features>
        - Login Endpoint
        - Registration Form
      </sub_features>
    </feature>
    <!-- Additional features -->
  </core_features>

  <database>
    <!-- Database schema definitions -->
  </database>

  <api_endpoints>
    <!-- API contract definitions -->
  </api_endpoints>

  <success_criteria>
    - Criteria 1
    - Criteria 2
  </success_criteria>
</project_specification>
```

> [!TIP]
> You can manually edit `app_spec.md` at any time. The autonomous agent re-reads this file at the start of every session.

---

## Security & Configuration

Configuration is managed via `autocode.toml` in the project root. You can also configure global defaults in `~/.config/opencode/autocode.toml` (OS dependent).

### Security Constraints
To prevent the agent from causing harm, `opencode-autocode` enforces a strict allowlist and blocked patterns list.

**Blocked Patterns (Default):**
*   `rm -rf /`
*   `rm -rf ~`
*   `sudo`
*   `curl | bash`
*   `chmod 777`
*   `> /dev/sda`

### Configuration Options (`autocode.toml`)

| Section          | Key                      | Default                             | Description                                        |
| :--------------- | :----------------------- | :---------------------------------- | :------------------------------------------------- |
| **[models]**     | `default`                | "opencode/glm-4.7-free"             | Model for general spec generation.                 |
|                  | `autonomous`             | "opencode/minimax-m2.1-free"        | High-capacity model for coding loop.               |
|                  | `reasoning`              | "opencode/glm-4.7-free"             | Model for planning and architecture.               |
|                  | `fixer`                  | "opencode/grok-code"                | specialized model for fixing syntax/format errors. |
| **[autonomous]** | `delay_between_sessions` | 5                                   | Seconds to wait between vibe loops.                |
|                  | `max_iterations`         | 0                                   | Max loops (0 = infinite).                          |
|                  | `auto_commit`            | true                                | Commit changes after success.                      |
| **[agent]**      | `max_retry_attempts`     | 3                                   | Retries per feature before giving up.              |
|                  | `single_feature_focus`   | true                                | Forces agent to work on one feature at a time.     |
| **[generation]** | `complexity`             | "comprehensive"                     | "comprehensive" or "minimal".                      |
|                  | `enable_subagents`       | true                                | Use parallel sub-calls for spec generation.        |
| **[security]**   | `enforce_allowlist`      | true                                | Strictly enforce tooling allowlist.                |
|                  | `allowlist_file`         | ".autocode/security-allowlist.json" | Path to the allowed commands file.                 |
| **[ui]**         | `colored_output`         | true                                | Enable ANSI colors.                                |
|                  | `verbose`                | true                                | Show detailed logs.                                |
| **[conductor]**  | `planning_mode`          | "auto"                              | "auto" (AI) or "manual".                           |

---

## CLI Reference

### Root Command

```
Usage: opencode-autocode [OPTIONS] [COMMAND]
```

**Options:**
*   `--interactive`: Force interactive wizard mode.
*   `--spec <FILE>`: Use a custom spec file path.
*   `--dry-run`: Preview actions without making changes.
*   `--verbose`: Enable debug logging.

### `vibe`
Starts the autonomous coding loop.

```bash
opencode-autocode vibe --limit 10 --developer
```

**Example Output:**
```text
[INFO] Starting Vibe Loop (Iteration 1/10)
[INFO] Selected Feature: #[12] User Authentication
[PLAN] Reasoning about implementation strategy...
[EXEC] Writing file: src/auth/mod.rs
[EXEC] Writing file: src/auth/jwt.rs
[TEST] Running verification: cargo test auth
[PASS] Verification successful.
[GIT]  Committed: "feat: implement user authentication"
[INFO] Resting for 5 seconds...
```

### `init`
Initialize a new project (alias for interactive mode but with CLI flags).

```bash
opencode-autocode init --spec my-spec.md --no-subagents
```

### `db`
Manage the internal SQLite database tracking feature progress.

**Subcommands:**
*   `init`: Create the database.
*   `migrate`: Import features from `feature_list.json`.
*   `stats`: Show progress statistics.
*   `query <SQL>`: Run a raw SQL query.
*   `check`: Run consistency checks.

**Example: Check Stats**
```bash
opencode-autocode db stats
```
```text
+-------------------+-------+
| Metric            | Value |
+-------------------+-------+
| Total Features    | 45    |
| Completed         | 12    |
| Pending           | 33    |
| Completion Rate   | 26.6% |
+-------------------+-------+
```

### `templates`
Manage project templates.

*   `list`: Show available templates.
*   `use <NAME>`: Apply a template to the current directory.

### `example`
Print documentation/example text for various topics.

```bash
opencode-autocode example verify
```
```text
# Verification Examples

## Rust
cargo test
cargo clippy -- -D warnings

## Node.js
npm test
npm run lint
```
