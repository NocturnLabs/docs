# OpenCode Autocode

**OpenCode Autocode** is a high-performance autonomous coding engine and scaffolding framework designed for the OpenCode ecosystem. It enables developers to transition from high-level product requirements to fully implemented, verified, and refined source code using a suite of coordinated AI agents.

> [!IMPORTANT]
> This tool is part of the **NocturnLabs Tools** suite. It is designed to operate with significant autonomy; ensure your `autocode.toml` security settings are configured for your environment.

---

## Technical Overview

OpenCode Autocode operates as a **finite state machine (FSM)** coordinated by a central "Conductor". It maintains a persistent state via an internal SQLite database, allowing sessions to resume seamlessly across restarts or crashes.

### The "Vibe Loop" Mechanics
The core of Autocode is the "Vibe Loop", an autonomous execution cycle that follows these phases:
1.  **Selection**: Queries the local database for the next incomplete feature based on priority and category.
2.  **Reasoning**: Analyzes the `app_spec.md`, current codebase context, and existing `product.md` to formulate a multi-step implementation plan.
3.  **Implementation**: Executes the plan using a "Coder" agent model. This involves creating new files, refactoring existing ones, and maintaining architectural consistency.
4.  **Verification**: Automatically runs the `verification_command` associated with the feature (e.g., `cargo test`, `npm test`, or custom scripts).
5.  **Recovery**: If verification fails, the agent enters a "Fixer" state, using specialized models (like `grok-code`) to diagnose and resolve errors.
6.  **Commit**: Upon successful verification, changes are staged and committed to Git with a semantic message.

---

## Installation

### Method 1: Build from Source (Latest Features)
Building from source ensures you have the latest performance optimizations and MCP tools.

```bash
# Clone the repository
git clone https://github.com/nocturnlabs/opencode-autocode.git
cd opencode-autocode

# Build and install locally
cargo install --path .
```

### Method 2: Pre-compiled binaries
Download the platform-specific binary from the [Releases](https://github.com/nocturnlabs/opencode-autocode/releases) page.

```bash
# Example for Linux/macOS
chmod +x opencode-autocode
mv opencode-autocode /usr/local/bin/
```

---

## Getting Started

### Quick Start (Interactive Scaffolding)
For new projects, launch the interactive TUI wizard to define your project vision:

```bash
opencode-autocode --interactive
```

### Advanced: The Headless Vibe Loop
If you already have an `app_spec.md` and want the agent to start building immediately:

```bash
# Start autonomous execution with a limit of 10 features
opencode-autocode vibe --limit 10 --developer
```

---

## Core Systems Deep Dive

### 1. Conductor Context System
The **Conductor** manages project-level intelligence. It expects a `.conductor/` directory containing:
*   `product.md`: The "North Star" document describing the product vision.
*   `tech_stack.md`: Hard constraints on technologies, versions, and patterns.
*   `architecture.md`: High-level system design.
*   `tracks/`: Individual directories for each feature, housing granular `plan.md` files that track sub-task completion (`- [ ]` vs `- [x]`).

### 2. Knowledge Base
Autocode maintains a **persistent knowledge base** (Key-Value store) in the database. This allows agents to "remember" facts across features, such as internal port numbers, API URLs, or specific dev environment quirks.

```bash
# Save a fact to the knowledge base
opencode-autocode db knowledge set dev_port 8080 --category "env"
```

### 3. Agent-User Communication Channel
When the agent encounters an ambiguity that it cannot resolve autonomously (e.g., conflicting requirements), it posts a question to `.autocode/COMMUNICATION.md`.
*   Users can respond directly in the markdown file.
*   The agent polls this file at the start of every vibe session.
*   Resolved questions are archived automatically.

### 4. Parallel Workers
For large projects, Autocode supports horizontal scaling via **Git Worktrees**.

```bash
# Run 4 workers in parallel
opencode-autocode vibe --parallel 4
```
Each worker operates in a separate worktree, implementing a distinct feature and merging back to the primary branch upon verification.

---

## Specification Reference (`app_spec.md`)

The `app_spec.md` is the primary source of truth. It uses a structured XML format to ensure high-fidelity parsing by LLMs.

### Root Schema
```xml
<project_specification>
  <project_name>Unique Name</project_name>
  <overview>Detailed purpose...</overview>
  
  <technology_stack>
    <languages>Rust, Go, etc.</languages>
    <frameworks>Tokio, Actix, etc.</frameworks>
  </technology_stack>

  <core_features>
    <feature priority="critical">
      <name>System Auth</name>
      <description>...</description>
      <sub_features>
        - Task A
        - Task B
      </sub_features>
    </feature>
  </core_features>
</project_specification>
```

---

## Security & Configuration

### Blocked Command Patterns
To prevent destructive operations, the following patterns are prohibited in autonomous mode:
*   `rm -rf /`, `rm -rf ~`
*   `sudo`
*   `curl | bash`, `wget | bash`
*   Any command writing directly to device nodes (e.g., `> /dev/sda`).

### Full Configuration Reference (`autocode.toml`)

| Section             | Key                       | Default                        | Description                                      |
| :------------------ | :------------------------ | :----------------------------- | :----------------------------------------------- |
| **[models]**        | `default`                 | `"opencode/glm-4.7-free"`      | Default for spec generation.                     |
|                     | `autonomous`              | `"opencode/minimax-m2.1-free"` | High-token coding model.                         |
|                     | `fixer`                   | `"opencode/grok-code"`         | Specialized for syntax/fix tasks.                |
| **[agent]**         | `max_retry_attempts`      | `3`                            | Retries before initiating research protocol.     |
|                     | `single_feature_focus`    | `true`                         | Prevents scope creep by focusing on one feature. |
| **[mcp]**           | `use_sequential_thinking` | `true`                         | Enables multi-step internal reasoning.           |
|                     | `prefer_osgrep`           | `true`                         | Uses faster ripgrep-based codebase scanning.     |
| **[conductor]**     | `context_dir`             | `".conductor"`                 | Directory for project context.                   |
|                     | `checkpoint_frequency`    | `1`                            | Frequency of progress saves to disk.             |
| **[communication]** | `enabled`                 | `true`                         | Enables `.autocode/COMMUNICATION.md`.            |
|                     | `auto_ask_on_error`       | `true`                         | Posts to COMMUNICATION.md on repeated fails.     |

---

## CLI Reference

### `vibe`
Starts the autonomous cycle.

```bash
# Usage
opencode-autocode vibe [OPTIONS]

# Example (Headless, developer logging enabled)
opencode-autocode vibe --limit 5 --developer
```

**Believable TUI Output:**
```text
┌───────────────────────────────────────────────────────────┐
│  ✨ OpenCode Autocode - Autonomous Vibe Loop              │
└───────────────────────────────────────────────────────────┘
[INFO] Session #42 starting...
[INFO] Active Feature: #[3] Implement JWT Middleware
[PLAN] Track: auth-system | Plan: .conductor/tracks/auth-system/plan.md
[EXEC] Applying Task: "Add HS256 validation logic"
[EXEC] Modified: src/auth/jwt.rs
[TEST] Running: cargo test auth_jwt
[PASS] Verification successful.
[GIT]  feat: implement JWT middleware validation
[INFO] Resting for 5 seconds...
```

### `db`
Low-level database administration.

```bash
# Show project completion stats
opencode-autocode db stats

# Query the feature list directly
opencode-autocode db query "SELECT * FROM features WHERE passes=1"
```

**Believable Table Output:**
```text
ID  Category    Description                 Passes  Updated
──  ──────────  ──────────────────────────  ──────  ──────────────────
1   auth        JWT Secret Validation       1       2026-01-04 10:22
2   api         User profile endpoint       1       2026-01-04 11:45
5   db          Migration: Users Table      1       2026-01-04 12:10
```

### `example`
Quick access to technical guides and templates.

```bash
# Show database INSERT syntax for features
opencode-autocode example db --insert

# Show standard verification patterns
opencode-autocode example verify
```

### `update`
Self-updates the binary to the latest release on GitHub.

```bash
opencode-autocode update
```
